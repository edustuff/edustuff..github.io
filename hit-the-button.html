<!DOCTYPE html>
<html>
<head>
    <style>
.grid-container {
  display: grid;
  grid-template-columns: auto auto auto auto;
  background: rgba(24, 153, 218, 1);
}

* {
   font-family: sans-serif;
}

.grid-item {
  padding-top:3vh;
  padding-bottom:3vh;
  border-radius: 3vw;
  background: rgb(240, 139, 37, 1);
  background: linear-gradient(45deg, rgba(240, 139, 37, 1) 0%, rgba(229, 63, 50, 1) 100%);
  border: 1vw solid rgba(24, 153, 218, 1);
  font-size: 5vw;
  text-align: center;
}

.container {
    background-color: rgba(25, 68, 146, 1);
}

body {
    background-color: rgba(25, 68, 146, 1);
}

button {
  margin-top: 3vw;
  margin-button: 3vw;
  padding-left: 3vw;
  padding-right: 3vw;
  display: block;
  margin-left: auto;
  margin-right: auto;
}

#question {
  padding: 3vw;
  color: #ff3;
  font-size: 6vw;
  text-align: center;
  margin-top: 0px;
  margin-bottom: 0px;
}

questionMinor {
  padding: 3vw;
  font-size: 4vw;
  text-align: center;
  margin-top: 0px;
  margin-bottom: 0px;
}

#question > .hidden {
  font-size: 0;
}

#timeRemaining,#score,#finalScore {
  padding: 3vw;
  color: #fff;
  font-size: 4vw;
  text-align: center;
  margin-top: 0px;
  margin-bottom: 0px;
}

#prompt {
  padding: 3vw;
  color: red;
  font-size: 4vw;
  text-align: center;
  margin-top: 0px;
  margin-bottom: 0px;
}

#gameScreen {
    position: absolute;
    top: 0px;
    width: 100%;
    visibility: hidden;
}

#startScreen {
    position: absolute;
    top: 0px;
    width: 100%;
}



</style>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="user-scalable=no, width=device-width" />
    <link rel="apple-touch-icon" href="Icon2dx.png" />

</head>

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/6.6.0/math.min.js"></script>

<!--<script src="libs/tex-mml-chtml.js"></script>-->
<!--<script src="libs/math.min.js"></script>-->

<script src="questions/indicies.js"></script>
<script src="questions/percentages.js"></script>
<script src="questions/prime.js"></script>
<script src="questions/sequences.js"></script>
<script src="questions/operation-order.js"></script>
<script src="questions/conversions.js"></script>
<script src="questions/averages.js"></script>
<script src="questions/fraction-to-decimal.js"></script>
<script src="questions/fraction-to-percentage.js"></script>
<script src="questions/fraction-addition.js"></script>
<script src="questions/fraction-simplify.js"></script>
<script src="questions/fraction-of.js"></script>
<script src="questions/biggest-smallest.js"></script>

<script>

    var totalScore = 0;
    var timeRemaining = 60;
    var correctTotal = 0;
    var incorrectTotal = 0;

    var maxType = 1;
    var curQuestionType = 1;

    var currentQuestionId = 0;
    var numberOfQuestions = 12;

    var maxQuestionCount = 10;

    var timer;

    var questions = [];
    var uniqueAnswers = [];
    var questionsAsked = [];


    function inverseQuestions(originalQuestions) {

        var inversedQuestions = [];

        for (i = 0; i < originalQuestions.length; i++) {
            inversedQuestions.push({type : originalQuestions[i].type, question : originalQuestions[i].answer, answer: originalQuestions[i].question});
        }

        return inversedQuestions;
    }


    function showStartScreen() {
        document.getElementById("startScreen").style.visibility= 'visible' ;
    }

    function hideStartScreen() {
        document.getElementById("startScreen").style.visibility= 'hidden' ;
    }

    function showGameScreen() {
        document.getElementById("gameScreen").style.visibility= 'visible' ;
    }

    function hideGameScreen() {
        document.getElementById("gameScreen").style.visibility= 'hidden' ;
    }

    function initialiseGame(questionData, numOfQuestions, numberOfColumns, maxQuestCount) {

        console.log("Initialising Game");

        window.scrollTo(0, 0);

        questions = questionData;

        maxQuestionCount = maxQuestCount;

        uniqueAnswers = [];
        questionsAsked = [];

        totalScore = 0;
        timeRemaining = 60;
        correctTotal = 0;
        incorrectTotal = 0;
        maxType = 1;
        curQuestionType = 1;

        currentQuestionId = 0;

        numberOfQuestions = numOfQuestions;
        resizeGrid(numberOfQuestions, numberOfColumns);

        shuffle(questions);

        console.log("Questions shuffled");

        setAnswers();

        console.log("Questions set");

        hideStartScreen();
        showGameScreen();

        console.log("Game screen displayed");

        if (document.getElementById("timer").checked) {
            updateRemainingTime();
        } else {
            updateQuestionCount();
        }

        updateScore();

        console.log("Score, timer and question count reset");

        document.getElementById("prompt").innerHTML = "";

        if (!timer) {
            startTimer();
        }

        pickRandomQuestion();

        console.log("First question selected");

    }

    function endGame() {

        hideGameScreen();
        showStartScreen();
        updateFinalScore();

    }

    function startTimer() {

        timer = setInterval(function(){
            if (document.getElementById("timer").checked) {
                timeRemaining = timeRemaining - 1;
                updateRemainingTime();
                if (timeRemaining == 0) {
                    endGame();
                }
            } else {
                updateQuestionCount();
                var total = correctTotal + incorrectTotal;
                if (total >= maxQuestionCount) {
                    endGame();
                }
            }
        },1000);

    }

    function updateRemainingTime() {

        document.getElementById("timeRemaining").innerHTML = "Timer: " + timeRemaining;
    }

    function updateQuestionCount() {
        var total = correctTotal + incorrectTotal;
        document.getElementById("timeRemaining").innerHTML = "Question: " + (total + 1);
    }

    function updateFinalScore() {
        var total = correctTotal + incorrectTotal;
        document.getElementById("finalScore").innerHTML = "You scored " + correctTotal + " out of " + total + ".";
    }

    function setAnswers() {

        uniqueAnswers = [];
        uniqueQuestions = [];

        var uniqueAnswerIndex = 0;

        maxType = 1;

        for (i = 0; i < questions.length; i++) {
            if (questions[i].type > maxType) {
                maxType = questions[i].type;
            }
        }

        console.log("Question types = " + maxType);

        console.log("Target question count = " + numberOfQuestions);

        var curType = 1;

        var i=0;

        var attempt = 0;

        while (uniqueAnswerIndex < numberOfQuestions && attempt < 1000) {

            attempt = attempt + 1;

            if (questions[i].type == curType && uniqueAnswers.indexOf(questions[i].answer) == -1 && uniqueQuestions.indexOf(questions[i].question) == -1) {

                uniqueAnswers.push(questions[i].answer);
                uniqueQuestions.push(questions[i].question);

                document.getElementById(uniqueAnswerIndex).innerHTML = questions[i].answer;
                document.getElementById(uniqueAnswerIndex).setAttribute("questionid", i);
                document.getElementById(uniqueAnswerIndex).onclick = function(){checkAnswer(event)};

                uniqueAnswerIndex++;

                curType++;

                if (curType > maxType) {
                    curType = 1;
                }

            }

            i++;
            if (i == questions.length) {
                i = 0;
            }
        }

        if (uniqueAnswerIndex < numberOfQuestions) {
            alert ("Unable to reach target question count");
            console.log(uniqueAnswerIndex + " out of " + numberOfQuestions);
            console.log(questions);
        }

        MathJax.typeset();

    }



    function pickRandomQuestion() {

        var newQuestionId = currentQuestionId;

        while (questions[newQuestionId].type != curQuestionType || currentQuestionId == newQuestionId || (!uniqueAnswers.includes(questions[newQuestionId].answer) && !questions[newQuestionId].answers) || questionsAsked.includes(newQuestionId)) {
            newQuestionId = Math.floor(Math.random()*questions.length);
        }

        questionsAsked.push(newQuestionId);

        curQuestionType++;
        if (curQuestionType > maxType) {
            curQuestionType = 1;
        }

        currentQuestionId = newQuestionId;
        currentQuestion = questions[currentQuestionId];

        document.getElementById("question").innerHTML = currentQuestion.question;

        if (currentQuestion.answers && currentQuestion.answers.length > 0) {
            for (var i=0; i<currentQuestion.answers.length; i++) {
                document.getElementById(i).innerHTML = currentQuestion.answers[i];
                if (currentQuestion.answers[i] == currentQuestion.answer) {
                    document.getElementById(i).setAttribute("questionid", currentQuestionId);
                }
            }
        }

        MathJax.typeset();
    }

    function checkAnswer(event) {

        var element = event.target;

        questionId = element.getAttribute("questionid");

        while (questionId == undefined) {
            element = element.parentElement;
            questionId = element.getAttribute("questionid");
        }

        //alert(questionId + "," + currentQuestionId);

        providedAnswer = questions[questionId].answer;
        correctAnswer = questions[currentQuestionId].answer;

        isCorrect = providedAnswer == correctAnswer;

        if (isCorrect) {
            correctTotal++;
            document.getElementById("prompt").innerHTML = "";
            flashColour(element, "green");
        } else {
            if (questions[currentQuestionId].prompt) {
                document.getElementById("prompt").innerHTML = questions[currentQuestionId].prompt;
            } else {
                document.getElementById("prompt").innerHTML = questions[currentQuestionId].question + " = " + questions[currentQuestionId].answer;
            }

            incorrectTotal++;
            flashColour(element, "red");
        }

        //alert(providedAnswer + "," + correctAnswer + "," + isCorrect);

        updateScore();

        pickRandomQuestion();
    }

    function flashColour(element, colour) {
        var existingColour = element.style.background;
        element.style.background = colour;
         setTimeout(function(){
            element.style.background = existingColour;
        },300);
    }

    function updateScore() {
        var total = correctTotal + incorrectTotal;
        document.getElementById("score").innerHTML = "Score: " + correctTotal + "/" + total;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        let j = Math.floor(Math.random() * (i + 1)); // random index from 0 to i

        // swap elements array[i] and array[j]
        // we use "destructuring assignment" syntax to achieve that
        // you'll find more details about that syntax in later chapters
        // same can be written as:
        // let t = array[i]; array[i] = array[j]; array[j] = t
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function resizeGrid(size, columnsCount) {
        var cells = document.querySelectorAll("#grid > div");
        var i;
        for (i = 0; i < cells.length; i++) {
          cells[i].remove();
        }

        for (i = 0; i < size; i++) {
          var newCell = document.createElement("DIV");
          newCell.setAttribute("id", i);
          newCell.setAttribute("class", "grid-item");
          document.getElementById("grid").appendChild(newCell);
        }

        var autoColumns = "";

        for (i = 0; i<columnsCount; i++) {
            autoColumns = autoColumns + "auto ";
        }

        document.getElementById("grid").style.gridTemplateColumns = autoColumns;

    }

</script>

<body>

<div id="startScreen">
    <p id="finalScore"></p>
    <input type="radio" name="gameType" id="timer"> Timer<br>
    <input type="radio" name="gameType" id="count" checked> Counter<br>
    <button class="grid-item" onclick="initialiseGame(getIndiciesQuestions(),12,4,10);">Squares, cubes and other powers 1</button>
    <button class="grid-item" onclick="initialiseGame(inverseQuestions(getIndiciesQuestions()),12,4,10);">Squares, cubes and other powers 2</button>
    <button class="grid-item" onclick="initialiseGame(getPercentageQuestions(),12,4,10);">Percentages 1</button>
    <button class="grid-item" onclick="initialiseGame(inverseQuestions(getPercentageQuestions()),12,4,10);">Percentages 2</button>
    <button class="grid-item" onclick="initialiseGame(getPrimeQuestions(),2,2,20);">Prime numbers</button>
    <button class="grid-item" onclick="initialiseGame(getSequenceQuestions(),12,4,10);">Sequences</button>
    <button class="grid-item" onclick="initialiseGame(getOperationOrderQuestions(),12,4,10);">BIDMAS</button>
    <button class="grid-item" onclick="initialiseGame(getConversionQuestions(),12,4,10);">Unit conversions</button>
    <button class="grid-item" onclick="initialiseGame(getMeanAverageQuestions(),8,4,10);">Averages</button>
    <button class="grid-item" onclick="initialiseGame(getFractionsToDecimal(),11,3,11);">Fractions to decimals</button>
    <button class="grid-item" onclick="initialiseGame(getFractionsToPercentage(),11,3,11);">Fractions to percentage</button>
    <button class="grid-item" onclick="initialiseGame(getFractionAdditions(),12,4,10);">Fraction additions, subtractions, multiplications and divisions</button>
    <button class="grid-item" onclick="initialiseGame(getFractionSimplifications(),9,3,10);">Simplify fractions</button>
    <button class="grid-item" onclick="initialiseGame(getFractionOf(),5,5,10);">Fraction of...</button>
    <button class="grid-item" onclick="initialiseGame(getBiggestSmallest(),5,5,10);">Biggest and smallest</button>
</div>

<div id="gameScreen">

<div class="container">
<p id="question">-</p>
</div>

<div id="grid" class="grid-container">
    <div id="0" class="grid-item"></div>
    <div id="1" class="grid-item"></div>
    <div id="2" class="grid-item"></div>
    <div id="3" class="grid-item"></div>
    <div id="4" class="grid-item"></div>
    <div id="5" class="grid-item"></div>
    <div id="6" class="grid-item"></div>
    <div id="7" class="grid-item"></div>
    <div id="8" class="grid-item"></div>
    <div id="9" class="grid-item"></div>
    <div id="10" class="grid-item"></div>
    <div id="11" class="grid-item"></div>
</div>

<div class="container">
<p id="prompt"></p>
<p id="timeRemaining">Timer:</p>
<p id="score">Score:</p>
</div>
</div>


</body>
</html>
